/* Generated by wbuild from "FText.w"
** (generator version $Revision$ of $Date$)
*/
#if HAVE_CONFIG_H
#  include <config.h>
#endif

#include <X11/IntrinsicP.h>
#include <X11/StringDefs.h>
#line 2293 "FText.w"
#include <assert.h>
#line 2294 "FText.w"
#include <stdio.h>
#line 2295 "FText.w"
#include <Xm/ScrollBar.h>
#line 2296 "FText.w"
#include "line3d.bm"
#include <Xfwf/FTextP.h>
#line 1042 "FText.w"
static void activate(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 1079 "FText.w"
static void motion(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);

static XtActionsRec actionsList[] = {
{"activate", activate},
{"motion", motion},
};

static char defaultTranslations[] = "\
<Btn1Down>,<Btn1Up>: activate() \n\
<Motion>: motion() \n\
<Enter>: motion() \n\
<Leave>: motion() \n\
";
static void _resolve_inheritance(
#if NeedFunctionPrototypes
WidgetClass
#endif
);
#line 481 "FText.w"
static void initialize(
#if NeedFunctionPrototypes
Widget ,Widget,ArgList ,Cardinal *
#endif
);
#line 577 "FText.w"
static void destroy(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 604 "FText.w"
static void resize(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 626 "FText.w"
static void expose(
#if NeedFunctionPrototypes
Widget,XEvent *,Region 
#endif
);
#line 674 "FText.w"
static XtGeometryResult  geometry_manager(
#if NeedFunctionPrototypes
Widget ,XtWidgetGeometry *,XtWidgetGeometry *
#endif
);
#line 719 "FText.w"
static XtGeometryResult  query_geometry(
#if NeedFunctionPrototypes
Widget,XtWidgetGeometry *,XtWidgetGeometry *
#endif
);
#line 754 "FText.w"
static void add_word(
#if NeedFunctionPrototypes
Widget,const  String ,Cardinal ,Pixel ,Pixel ,TextStyle ,XtPointer 
#endif
);
#line 780 "FText.w"
static void add_hspace(
#if NeedFunctionPrototypes
Widget,int ,Bool ,Bool ,Pixel ,Pixel ,TextStyle ,XtPointer 
#endif
);
#line 806 "FText.w"
static void add_vspace(
#if NeedFunctionPrototypes
Widget,int 
#endif
);
#line 834 "FText.w"
static void add_inline(
#if NeedFunctionPrototypes
Widget,Widget ,TextStyle ,int ,int ,int ,int ,int ,XtPointer 
#endif
);
#line 884 "FText.w"
static void add_parshape(
#if NeedFunctionPrototypes
Widget,int ,int ,int ,int ,double 
#endif
);
#line 911 "FText.w"
static void add_hrule(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 933 "FText.w"
static void add_eod(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 944 "FText.w"
static void pass_click(
#if NeedFunctionPrototypes
Widget,Widget ,int ,int 
#endif
);
#line 966 "FText.w"
static void reformat_scrollbar(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 985 "FText.w"
static int  get_em_of_textstyle(
#if NeedFunctionPrototypes
Widget,TextStyle 
#endif
);
#line 995 "FText.w"
static int  get_space_of_textstyle(
#if NeedFunctionPrototypes
Widget,TextStyle 
#endif
);
#line 1006 "FText.w"
static void get_lineheight_of_textstyle(
#if NeedFunctionPrototypes
Widget,TextStyle ,int *,int *
#endif
);
#line 1020 "FText.w"
static void get_word_extent(
#if NeedFunctionPrototypes
Widget,const  String ,Cardinal ,TextStyle ,int *,int *,int *,int *
#endif
);
#line 1128 "FText.w"
#define PREF_WD 150 


#line 1129 "FText.w"
#define PREF_HT 150 


#line 1133 "FText.w"
#define new(p) ((p )=(XtPointer )XtMalloc (sizeof (*(p ))))


#line 1134 "FText.w"
#define renewarray(p, n) ((p )=(XtPointer )XtRealloc ((String )p ,(n )*sizeof (*(p ))))


#line 1140 "FText.w"
static void draw_word(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1171 "FText.w"
static void draw_hspace(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1199 "FText.w"
static void draw_inline(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1213 "FText.w"
static void draw_hrule(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1220 "FText.w"
static void draw_chunks(
#if NeedFunctionPrototypes
Widget,FtChunk ,FtChunk 
#endif
);
#line 1267 "FText.w"
#define set_max(a, b) if ((a )>=(b ));else (a )=(b )


#line 1268 "FText.w"
#define set_min(a, b) if ((a )<=(b ));else (a )=(b )


#line 1269 "FText.w"
#define min(a, b) ((a )<(b )?(a ):(b ))


#line 1270 "FText.w"
#define max(a, b) ((a )>(b )?(a ):(b ))


#line 1271 "FText.w"
#define round(f) ((int )((f )+0.5 ))


#line 1276 "FText.w"
static void init_par_builder(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 1294 "FText.w"
static void append(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1306 "FText.w"
static String  strndup(
#if NeedFunctionPrototypes
const  String ,Cardinal 
#endif
);
#line 1317 "FText.w"
static int  find_line_below_y(
#if NeedFunctionPrototypes
FtLine *,int ,int 
#endif
);
#line 1334 "FText.w"
static FtChunk  local_find_chunk_at_xy(
#if NeedFunctionPrototypes
FtLine *,int ,int ,int 
#endif
);
#line 1351 "FText.w"
static FtChunk  find_chunk_at_xy(
#if NeedFunctionPrototypes
Widget,int ,int 
#endif
);
#line 1365 "FText.w"
static void resort_lines_vertically(
#if NeedFunctionPrototypes
FtLine *,int 
#endif
);
#line 1387 "FText.w"
#define INCR 50 


#line 1389 "FText.w"
static void append_line(
#if NeedFunctionPrototypes
Widget,int ,int ,int ,int ,int ,FtChunk ,FtChunk 
#endif
);
#line 1440 "FText.w"
static FtChunk  find_parshape_before(
#if NeedFunctionPrototypes
FtChunk 
#endif
);
#line 1452 "FText.w"
#define is_breakable(h) ((h ->tp ==FtHSpace &&h ->u.hspace.breakable )||h ->tp ==FtVSpace ||h ->tp ==FtParShape ||h ->tp ==FtHRule )


#line 1461 "FText.w"
static void render_one_line(
#if NeedFunctionPrototypes
Widget,FtChunk ,FtChunk ,int ,int ,int ,int ,int ,int ,int ,int ,Bool 
#endif
);
#line 1513 "FText.w"
static FtChunk  find_break(
#if NeedFunctionPrototypes
FtChunk ,FtChunk ,int *,int *,int *,int *
#endif
);
#line 1531 "FText.w"
static int  left_float_width(
#if NeedFunctionPrototypes
Widget,int ,int 
#endif
);
#line 1545 "FText.w"
static int  right_float_width(
#if NeedFunctionPrototypes
Widget,int ,int 
#endif
);
#line 1561 "FText.w"
static int  compute_width(
#if NeedFunctionPrototypes
Widget,FtChunk ,int ,int 
#endif
);
#line 1603 "FText.w"
static FtChunk  render_paragraphs(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1726 "FText.w"
static void format_vspace(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1746 "FText.w"
static void format_inline(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1795 "FText.w"
static int  find_width_before(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1814 "FText.w"
static void format_parshape(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1883 "FText.w"
static void format_hrule(
#if NeedFunctionPrototypes
Widget,FtChunk 
#endif
);
#line 1929 "FText.w"
static void unmap_children(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 1956 "FText.w"
static void scroll_cb(
#if NeedFunctionPrototypes
Widget ,XtPointer ,XtPointer 
#endif
);
#line 1979 "FText.w"
static Boolean  do_layout(
#if NeedFunctionPrototypes
XtPointer 
#endif
);
#line 2009 "FText.w"
static void install_do_layout(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 2029 "FText.w"
static void load_font(
#if NeedFunctionPrototypes
Widget,int ,int ,int 
#endif
);
#line 2181 "FText.w"
static void interpret_style(
#if NeedFunctionPrototypes
Widget,TextStyle ,int *,int *,int *,int *
#endif
);
#line 2207 "FText.w"
static void font_extents(
#if NeedFunctionPrototypes
Widget,TextStyle ,const  String ,int ,int *,int *,int *,int *
#endif
);
#line 2220 "FText.w"
static void font_space(
#if NeedFunctionPrototypes
Widget,TextStyle ,int *,int *,int *,int *
#endif
);
#line 2232 "FText.w"
static Font  font_id(
#if NeedFunctionPrototypes
Widget,TextStyle 
#endif
);
#line 2242 "FText.w"
static void dump_chunk(
#if NeedFunctionPrototypes
FtChunk 
#endif
);
#line 2283 "FText.w"
static void dump(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 1140 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1140 "FText.w"
static void draw_word(Widget self,FtChunk  p)
#else
#line 1140 "FText.w"
static void draw_word(self,p)Widget self;FtChunk  p;
#endif
#line 1141 "FText.w"
{
    int fam, sty, siz, raise, ulpos, ulthick, w;

    assert(p->tp == FtWord);
    XSetFont(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc, p->u.word.fid);
    XSetForeground(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc, p->u.word.fg);
    if (p->u.word.bg != TRANSPARENT)
	XSetBackground(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc, p->u.word.bg);

    if (p->u.word.bg == TRANSPARENT)
	XDrawString(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc,
		    p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset, p->u.word.text, p->u.word.len);
    else
	XDrawImageString(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc,
			 p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset, p->u.word.text, p->u.word.len);

    if (p->u.word.style & (FtUNDERSCORE | FtUNDERSCORE2)) {
	interpret_style(self, p->u.word.style, &fam, &sty, &siz, &raise);
	ulpos = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].ulpos;
	ulthick = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].ulthick;
	w = XTextWidth(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs, p->u.word.text, p->u.word.len);
	if (w != 0 && ulthick != 0 && (p->u.word.style & FtUNDERSCORE))
	    XFillRectangle(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc,
			   p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset + ulpos, w, ulthick);
	if (w != 0 && ulthick != 0 && (p->u.word.style & FtUNDERSCORE2))
	    XFillRectangle(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc,
			   p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset + ulpos + 2, w, ulthick);
    }
}
#line 1171 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1171 "FText.w"
static void draw_hspace(Widget self,FtChunk  p)
#else
#line 1171 "FText.w"
static void draw_hspace(self,p)Widget self;FtChunk  p;
#endif
#line 1172 "FText.w"
{
    int fam, sty, siz, raise, ulpos, ulthick;

    /* assert(p->tp == FtHSpace); */
    if (p->w > 0 && p->u.hspace.bg != TRANSPARENT) {
	XSetForeground(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc, p->u.hspace.bg);
	XFillRectangle(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc, p->x,
		       p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset - p->h, p->w, p->h + p->d);
    }

    if (p->w > 0 && (p->u.hspace.style & (FtUNDERSCORE | FtUNDERSCORE2))) {
	interpret_style(self, p->u.hspace.style, &fam, &sty, &siz, &raise);
	ulpos = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].ulpos;
	ulthick = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].ulthick;
	if (ulthick != 0 && (p->u.hspace.style & FtUNDERSCORE))
	    XFillRectangle(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc,
			   p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset + ulpos, p->w, ulthick);
	if (ulthick != 0 && (p->u.hspace.style & FtUNDERSCORE2))
	    XFillRectangle(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc,
			   p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset + ulpos + 2, p->w, ulthick);
    }
}
#line 1199 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1199 "FText.w"
static void draw_inline(Widget self,FtChunk  p)
#else
#line 1199 "FText.w"
static void draw_inline(self,p)Widget self;FtChunk  p;
#endif
#line 1200 "FText.w"
{
    Widget w = p->u.inlined.widget;
    if (((XfwfFormattedTextWidget)w)->core.x != p->x + p->u.inlined.hmargin
	|| ((XfwfFormattedTextWidget)w)->core.y != p->y - p->h + p->u.inlined.vmargin - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset) {
	XtMoveWidget(w, p->x + p->u.inlined.hmargin,
		     p->y - p->h + p->u.inlined.vmargin - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset);
    }
    if (! p->u.inlined.mapped) {
	XtMapWidget(w);
	p->u.inlined.mapped = TRUE;
    }
}
#line 1213 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1213 "FText.w"
static void draw_hrule(Widget self,FtChunk  p)
#else
#line 1213 "FText.w"
static void draw_hrule(self,p)Widget self;FtChunk  p;
#endif
#line 1214 "FText.w"
{
    XSetTSOrigin(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc, p->x, p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset);
    XFillRectangle(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc, p->x,
		   p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset, p->w, p->d);
}
#line 1220 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1220 "FText.w"
static void draw_chunks(Widget self,FtChunk  first,FtChunk  stop)
#else
#line 1220 "FText.w"
static void draw_chunks(self,first,stop)Widget self;FtChunk  first;FtChunk  stop;
#endif
#line 1221 "FText.w"
{
    for (; first != stop; first = first->next)
	switch (first->tp) {
	case FtWord: draw_word(self, first); break;
	case FtHSpace: draw_hspace(self, first); break;
	case FtVSpace: break;
	case FtInline: draw_inline(self, first); break;
	case FtParShape: break;
	case FtHRule: draw_hrule(self, first); break;
	default: assert(! "Cannot happen");
	}
}
#line 1276 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1276 "FText.w"
static void init_par_builder(Widget self)
#else
#line 1276 "FText.w"
static void init_par_builder(self)Widget self;
#endif
#line 1277 "FText.w"
{
    Widget vscroll = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vscrollbar;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth = ((XfwfFormattedTextWidget)self)->core.width - ((XfwfFormattedTextWidget)vscroll)->core.width;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos = 0;					/* Bottom of previous line */
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos = 0;				/* Bottom of left floats */
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos = 0;				/* Bottom of right floats */
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render = NULL;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines = 0;
}
#line 1294 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1294 "FText.w"
static void append(Widget self,FtChunk  p)
#else
#line 1294 "FText.w"
static void append(self,p)Widget self;FtChunk  p;
#endif
#line 1295 "FText.w"
{
    p->next = NULL;
    p->prev = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last;
    if (! ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks = p;
    else ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last->next = p;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last = p;
}
#line 1306 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1306 "FText.w"
static String  strndup(const  String  s,Cardinal  n)
#else
#line 1306 "FText.w"
static String  strndup(s,n)const  String  s;Cardinal  n;
#endif
#line 1307 "FText.w"
{
    String t = XtMalloc((n + 1) * sizeof(*t));
    *t = '\0';
    strncat(t, s, n);
    return t;
}
#line 1317 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1317 "FText.w"
static int  find_line_below_y(FtLine * lines,int  nrlines,int  y)
#else
#line 1317 "FText.w"
static int  find_line_below_y(lines,nrlines,y)FtLine * lines;int  nrlines;int  y;
#endif
#line 1318 "FText.w"
{
    int l = 0, h = nrlines, m;

    while (l != h) {
        m = (l + h)/2;
        if (lines[m].y <= y) l = m + 1; else h = m;
    }
    assert(l == 0 || lines[l-1].y <= y);
    return l;
}
#line 1334 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1334 "FText.w"
static FtChunk  local_find_chunk_at_xy(FtLine * lines,int  nrlines,int  x,int  y)
#else
#line 1334 "FText.w"
static FtChunk  local_find_chunk_at_xy(lines,nrlines,x,y)FtLine * lines;int  nrlines;int  x;int  y;
#endif
#line 1335 "FText.w"
{
    int n;
    FtChunk p;

    n = find_line_below_y(lines, nrlines, y) - 1;
    if (n >= 0 && lines[n].y + lines[n].h > y
        && lines[n].x <= x && lines[n].x + lines[n].w > x) {
	assert(lines[n].y <= y);
        for (p = lines[n].start; p && p != lines[n].stop; p = p->next)
            if (p->x <= x && x < p->x + p->w
                && p->y - p->h <= y && y < p->y + p->d)
                return p;
    }
    return NULL;
}
#line 1351 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1351 "FText.w"
static FtChunk  find_chunk_at_xy(Widget self,int  x,int  y)
#else
#line 1351 "FText.w"
static FtChunk  find_chunk_at_xy(self,x,y)Widget self;int  x;int  y;
#endif
#line 1352 "FText.w"
{
    FtChunk p;

    p = local_find_chunk_at_xy(((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines, x, y);
    if (! p) p = local_find_chunk_at_xy(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines, x, y);
    if (! p) p = local_find_chunk_at_xy(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines, x, y);
    return p;
}
#line 1365 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1365 "FText.w"
static void resort_lines_vertically(FtLine * lines,int  nrlines)
#else
#line 1365 "FText.w"
static void resort_lines_vertically(lines,nrlines)FtLine * lines;int  nrlines;
#endif
#line 1366 "FText.w"
{
    int i, j;
    FtLine h;

    j = nrlines - 1;				/* The line to insert */
    i = nrlines - 2;
    while (i >= 0 && lines[i].y > lines[j].y) i--;
    if (i < nrlines - 2) {
	i++;
	h = lines[j];
	for (; j > i; j--) lines[j] = lines[j-1]; /* Shift lines */
	lines[i] = h;
    }
}
#line 1389 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1389 "FText.w"
static void append_line(Widget self,int  mode,int  x,int  y,int  w,int  h,FtChunk  start,FtChunk  stop)
#else
#line 1389 "FText.w"
static void append_line(self,mode,x,y,w,h,start,stop)Widget self;int  mode;int  x;int  y;int  w;int  h;FtChunk  start;FtChunk  stop;
#endif
#line 1390 "FText.w"
{
    if ((mode & FtLEFTFLOAT)) {
	assert(((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines <= ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines_alloc);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines == ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines_alloc) {
	    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines_alloc = (((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines_alloc + INCR)/INCR * INCR;
	    renewarray(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines_alloc);
	}
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines].x = x;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines].y = y;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines].w = w;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines].h = h;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines].start = start;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines].stop = stop;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines++;
        resort_lines_vertically(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines);
    } else if ((mode & FtRIGHTFLOAT)) {
	assert(((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines <= ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines_alloc);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines == ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines_alloc) {
	    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines_alloc = (((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines_alloc + INCR)/INCR * INCR;
	    renewarray(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines_alloc);
	}
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines].x = x;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines].y = y;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines].w = w;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines].h = h;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines].start = start;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines].stop = stop;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines++;
        resort_lines_vertically(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines);
    } else {
	assert(((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines <= ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines_alloc);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines == ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines_alloc) {
	    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines_alloc = (((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines_alloc + INCR)/INCR * INCR;
	    renewarray(((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines_alloc);
	}
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines].x = x;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines].y = y;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines].w = w;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines].h = h;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines].start = start;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines].stop = stop;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines++;
        resort_lines_vertically(((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines);
    }
}
#line 1440 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1440 "FText.w"
static FtChunk  find_parshape_before(FtChunk  h)
#else
#line 1440 "FText.w"
static FtChunk  find_parshape_before(h)FtChunk  h;
#endif
#line 1441 "FText.w"
{
#if 0
    if (h == NULL) return NULL;
    else if (h->tp == FtParShape) return h;
    else return find_parshape_before(h->prev);
#else
    while (h && h->tp != FtParShape) h = h->prev;
    return h;
#endif
}
#line 1461 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1461 "FText.w"
static void render_one_line(Widget self,FtChunk  first,FtChunk  stop,int  mode,int  x,int  top,int  maxht,int  maxdp,int  targetwd,int  sumwd,int  sumstretch,Bool  may_fill)
#else
#line 1461 "FText.w"
static void render_one_line(self,first,stop,mode,x,top,maxht,maxdp,targetwd,sumwd,sumstretch,may_fill)Widget self;FtChunk  first;FtChunk  stop;int  mode;int  x;int  top;int  maxht;int  maxdp;int  targetwd;int  sumwd;int  sumstretch;Bool  may_fill;
#endif
#line 1462 "FText.w"
{
    FtChunk p;
    int desiredwhite, minwhite, startx, base;

    assert(! is_breakable(first));
    while (stop->prev != first
	   && stop->prev->tp != FtWord && stop->prev->tp != FtInline)
        stop = stop->prev;

    base = top + maxht;
    minwhite = sumstretch * SHRINK;
    if (sumwd + minwhite > targetwd)		/* Doesn't fit any way */
        desiredwhite = minwhite;
    else if (sumwd + sumstretch > targetwd)	/* Needs some shrink */
        desiredwhite = targetwd - sumwd;
    else if ((mode & FtJUSTIFYMASK) == FtJUSTIFYBOTH && may_fill)
        desiredwhite = targetwd - sumwd;
    else					/* Fits with normal spaces */
        desiredwhite = sumstretch;

    if ((mode & FtJUSTIFYMASK) == FtJUSTIFYCENTER)
	x += (targetwd - sumwd - desiredwhite)/2;
    else if ((mode & FtJUSTIFYMASK) == FtJUSTIFYRIGHT)
	x += targetwd - sumwd - desiredwhite;
    startx = x;

    for (p = first; p != stop; p = p->next) {	/* Set all coordinates */
	p->x = x;
	p->y = base;
	if (p->tp != FtHSpace || ! p->u.hspace.stretchable) {
	    x += p->w;
	} else {
	    assert(sumstretch != 0);
	    p->w = p->u.hspace.normwidth * desiredwhite/sumstretch;
	    x += p->w;
	    desiredwhite -= p->w;
	    sumstretch -= p->u.hspace.normwidth;
	}
    }
#if 0
    append_line(self, mode, startx, top, x - startx, maxht + maxdp, first, stop);
#endif
}
#line 1513 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1513 "FText.w"
static FtChunk  find_break(FtChunk  h,FtChunk  last,int * wd,int * stretch,int * ht,int * dp)
#else
#line 1513 "FText.w"
static FtChunk  find_break(h,last,wd,stretch,ht,dp)FtChunk  h;FtChunk  last;int * wd;int * stretch;int * ht;int * dp;
#endif
#line 1514 "FText.w"
{
    assert(h != last && is_breakable(last));
    *stretch = 0;  *wd = 0;  *ht = 0;  *dp = 0;
    do {
        if (h->tp != FtHSpace || ! h->u.hspace.stretchable) *wd += h->w;
        else *stretch += h->u.hspace.normwidth;
        set_max(*ht, h->h);
        set_max(*dp, h->d);
        h = h->next;
    } while (! is_breakable(h));
    return h;
}
#line 1531 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1531 "FText.w"
static int  left_float_width(Widget self,int  topy,int  boty)
#else
#line 1531 "FText.w"
static int  left_float_width(self,topy,boty)Widget self;int  topy;int  boty;
#endif
#line 1532 "FText.w"
{
    int i, w = 0;
    for (i = 0; i < ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines; i++) {
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].y >= boty) break;
	else if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].y + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].h < topy) continue;
	else set_max(w, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].x + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].w);
    }
    return w;
}
#line 1545 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1545 "FText.w"
static int  right_float_width(Widget self,int  topy,int  boty)
#else
#line 1545 "FText.w"
static int  right_float_width(self,topy,boty)Widget self;int  topy;int  boty;
#endif
#line 1546 "FText.w"
{
    int i, w = 0;
    for (i = 0; i < ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines; i++) {
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].y >= boty) break;
	else if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].y + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].h < topy) continue;
	else set_max(w, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].x);
    }
    return w;
}
#line 1561 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1561 "FText.w"
static int  compute_width(Widget self,FtChunk  p,int  ytop,int  ybottom)
#else
#line 1561 "FText.w"
static int  compute_width(self,p,ytop,ybottom)Widget self;FtChunk  p;int  ytop;int  ybottom;
#endif
#line 1562 "FText.w"
{
    int lft, rgt;

    assert(!p || p->tp == FtParShape);
    if (p == NULL) {
	/* No parshape, use full width minus floats */
	lft = left_float_width(self, ytop, ybottom);
	rgt = right_float_width(self, ytop, ybottom);
	return ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth - lft - rgt;
    } else if ((p->u.parshape.mode & (FtLEFTFLOAT | FtRIGHTFLOAT)) == 0) {
	/* This is normal paragraph */
	lft = left_float_width(self, ytop, ybottom);
	set_max(lft, p->u.parshape.left);
	rgt = right_float_width(self, ytop, ybottom);
	set_max(rgt, p->u.parshape.right);
        return ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth - lft - rgt;
    } else if (p->u.parshape.width > 0) {
	/* This is a floating par. with explicit width */
        return p->u.parshape.width;
    } else if (p->next && ! is_breakable(p->next)) {
	/* This is a floating par. without explicit width */
#if 0
	fprintf(stderr, "float width taken from next chunk (tp=%d): %d\n",
		p->next->tp, p->next->w);
#endif
	return p->next->w;
    } else {
	/* This is floating par. with nothing fixed following it */
#if 0
	fprintf(stderr, "float width estimated: %d\n",
		((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth/3 - p->u.parshape.left -
		p->u.parshape.right);
#endif
	return ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth/3 - p->u.parshape.left - p->u.parshape.right;
    }
}
#line 1603 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1603 "FText.w"
static FtChunk  render_paragraphs(Widget self,FtChunk  last)
#else
#line 1603 "FText.w"
static FtChunk  render_paragraphs(self,last)Widget self;FtChunk  last;
#endif
#line 1604 "FText.w"
{
    FtChunk p, p2, q, breakpoint;
    int mode, sumwd, maxht, maxdp, sumstretch;
    int wd, ht, dp, stretchwd, targetwd, targetwd1;
    int maxht1, maxdp1, sumwd1, sumstretch1, y, x, x1, x2;
    float leading;

    assert(last->tp != FtWord && last->tp != FtHSpace && last->tp != FtInline);

    if (! ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks;
    while (((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render != last && is_breakable(((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render))
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render->next;

    /* Find first parshape to use */
    p = find_parshape_before(((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render);

    while (((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render != last) {
        breakpoint = find_break(((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render, last,
				&sumwd, &sumstretch, &maxht, &maxdp);
        /* sumwd doesn't include the stretchable space */

	assert(!p || p->tp == FtParShape);        
        mode = p ? p->u.parshape.mode : 0;
	leading = p ? p->u.parshape.leading : 1.0;

        if (mode & FtRIGHTFLOAT) y = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace;
        else if (mode & FtLEFTFLOAT) y = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace;
        else y = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace;

        targetwd = compute_width(self, p, y, y + maxht + maxdp);
	if (targetwd < ((XfwfFormattedTextWidget)self)->core.width/10) {		/* Try to flush floats */
	    set_max(y, min(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace,
			   ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace));
	    targetwd = compute_width(self, p, y, y + maxht + maxdp);
	}
	if (targetwd < ((XfwfFormattedTextWidget)self)->core.width/10) {		/* Flush all floats */
	    set_max(y, max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace,
			   ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace));
	    targetwd = compute_width(self, p, y, y + maxht + maxdp);
	}

        while (breakpoint != last) {
            q = find_break(breakpoint, last, &wd, &stretchwd, &ht, &dp);
            sumwd1 = sumwd + wd;
            sumstretch1 = sumstretch + stretchwd;
            if (sumwd1 + sumstretch1 * SHRINK > targetwd)
                break;                  /* Break at last breakpoint */
            if (ht > maxht || dp > maxdp) { /* Recompute targetwd */
                maxht1 = max(maxht, ht);
                maxdp1 = max(maxdp, dp);
                targetwd1 = compute_width(self, p, y, y + maxht1 + maxdp1);
                if (sumwd1 + sumstretch1 * SHRINK > targetwd1)
                    break;              /* Doesn't fit, due to ht/dp */
                /* Still fits, despite larger height or depth */
                maxht = maxht1;
                maxdp = maxdp1;
                targetwd = targetwd1;
            }
            sumwd = sumwd1;
            sumstretch = sumstretch1;
            breakpoint = q;
        }

        /* breakpoint is best breakpoint, render one line */
        assert(is_breakable(breakpoint));
        if (mode & FtLEFTFLOAT) {
	    x1 = 0;
            x = p->u.parshape.left;
	    x2 = x + targetwd + p->u.parshape.right;
        } else if (mode & FtRIGHTFLOAT) {
            x = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth - targetwd - p->u.parshape.right;
	    x1 = x - p->u.parshape.left;
	    x2 = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth;
        } else if (! p) {
	    x = left_float_width(self, y, y + maxht + maxdp);
	    x1 = x;
	    x2 = x + targetwd;
        } else {
	    x1 = left_float_width(self, y, y + maxht + maxdp);
	    x = max(x1, p->u.parshape.left);
	    x2 = x + targetwd + p->u.parshape.right;
	    /* x2 may be too large, should we compare it to right_float? */
	}
        render_one_line(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render, breakpoint, mode, x, y, maxht,
			maxdp, targetwd, sumwd, sumstretch,
			breakpoint != last);
#if 1
	append_line(self, mode, x1, y, x2 - x1, maxht + maxdp,
		    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render, breakpoint);
#endif

        /* Set variables for next cycle */
        if (mode & FtLEFTFLOAT) {
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos = y + round((maxht + maxdp) * leading);
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace = 0;
        } else if (mode & FtRIGHTFLOAT) {
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos = y + round((maxht + maxdp) * leading);
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace = 0;
        } else {
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos = y + round((maxht + maxdp) * leading);
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace = 0;
        }
	/* Small optimization: if we encounter a parshape,
	 * we don't have to call find_parshape_before() below
	 */
	p2 = NULL;
        while (breakpoint != last && is_breakable(breakpoint)) {
	    if (breakpoint->tp == FtParShape) p2 = breakpoint;
            breakpoint = breakpoint->next;
	}
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render = breakpoint;

	/* Find parshape to use for next line */
	p = p2 ? p2 : find_parshape_before(((XfwfFormattedTextWidget)self)->xfwfFormattedText.next_to_render);
    }
    return p;
}
#line 1726 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1726 "FText.w"
static void format_vspace(Widget self,FtChunk  h)
#else
#line 1726 "FText.w"
static void format_vspace(self,h)Widget self;FtChunk  h;
#endif
#line 1727 "FText.w"
{
    FtChunk p;
    int mode;
    p = render_paragraphs(self, h);
    /* p = find_parshape_before(h); */
    mode = p ? p->u.parshape.mode : FtNORMALPARA;
    switch (mode & FtPOSITIONMASK) {
    case FtNORMALPARA: set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace, h->h); break;
    case FtLEFTFLOAT: set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace, h->h); break;
    case FtRIGHTFLOAT: set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace, h->h); break;
    default: assert(! "Cannot happen");
    }
}
#line 1746 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1746 "FText.w"
static void format_inline(Widget self,FtChunk  h)
#else
#line 1746 "FText.w"
static void format_inline(self,h)Widget self;FtChunk  h;
#endif
#line 1747 "FText.w"
{
    Widget w = h->u.inlined.widget;
    int wd, ht, dp, fixedht;
    int vm = h->u.inlined.vmargin, hm = h->u.inlined.hmargin;

    assert(! (h->u.inlined.style & FtHIDEWIDTH) || h->w == 0);
    if ((h->u.inlined.style & (FtHIDEWIDTH|FtALIGNFIXEDWIDTH)) == 0)
	h->w = ((XfwfFormattedTextWidget)w)->core.width + 2 * hm;
    font_space(self, h->u.inlined.style, &ht, &dp, &wd, &h->raise);
    if (h->u.inlined.style & FtALIGNFIXEDHEIGHT) {
        fixedht = h->h + h->d;
        switch (h->u.inlined.style & FtALIGNMASK) {
        case FtALIGNTOP:
            h->h = ht; h->d = fixedht - ht; break;
        case FtALIGNBOTTOM:
            h->d = dp; h->h = fixedht - dp; break;
        case FtALIGNMIDDLE:
            h->h = (fixedht + ht - dp)/2; h->d = fixedht - h->h; break;
	case FtALIGNDEPTH:
	    h->h = fixedht - h->d; break;
        default:
            assert(! "Cannot happen");
        }
	assert(h->h + h->d == fixedht);
    } else {					/* No fixed height */
	switch (h->u.inlined.style & FtALIGNMASK) {
	case FtALIGNTOP:
	    h->h = ht + vm; h->d = ((XfwfFormattedTextWidget)w)->core.height - ht + vm; break;
	case FtALIGNBOTTOM:
	    h->d = dp + vm; h->h = ((XfwfFormattedTextWidget)w)->core.height - dp + vm; break;
	case FtALIGNMIDDLE:
	    h->h = (((XfwfFormattedTextWidget)w)->core.height + ht - dp)/2 + vm;
	    h->d = ((XfwfFormattedTextWidget)w)->core.height - h->h + 2 * vm;
	    break;
	case FtALIGNDEPTH:
	    h->h = ((XfwfFormattedTextWidget)w)->core.height + 2 * vm - h->d; break;
	default:
	    assert(! "Cannot happen");
	}
    }
}
#line 1795 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1795 "FText.w"
static int  find_width_before(Widget self,FtChunk  h)
#else
#line 1795 "FText.w"
static int  find_width_before(self,h)Widget self;FtChunk  h;
#endif
#line 1796 "FText.w"
{
    h = h->prev;
    for (; h && h->tp != FtParShape && h->tp != FtInline; h = h->prev) ;
    if (! h) return -1;
    else if (h->tp == FtInline) return h->w;
    else if (h->u.parshape.mode & (FtLEFTFLOAT | FtRIGHTFLOAT)) {
        assert(h->u.parshape.width >= 0);
        return h->u.parshape.width;
    } else return -1;
}
#line 1814 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1814 "FText.w"
static void format_parshape(Widget self,FtChunk  p)
#else
#line 1814 "FText.w"
static void format_parshape(self,p)Widget self;FtChunk  p;
#endif
#line 1815 "FText.w"
{
    int width;

    (void) render_paragraphs(self, p);
    switch (p->u.parshape.mode & FtPOSITIONMASK) {
    case FtNORMALPARA:
        if (p->u.parshape.mode & FtCLEARLEFT)
            set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace);
        if (p->u.parshape.mode & FtCLEARRIGHT)
            set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos +((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace);
#if 0
        assert(left_float_width(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace)
            + right_float_width(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace)
            <= ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth);
#endif
        break;
    case FtLEFTFLOAT:
	set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace);
        if (p->u.parshape.mode & FtCLEARRIGHT)
            set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace);
        if (p->u.parshape.width >= 0)
            ;
        else if ((p->u.parshape.mode & FtKEEPWIDTH)
            && (width = find_width_before(self, p)) >= 0)
            p->u.parshape.width = width;
#if 0
        else /* if (p->u.parshape.width < 0) */
            p->u.parshape.width = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth/3
                - p->u.parshape.left - p->u.parshape.right;
#endif
        /* check if there is no collision of floats */
	if (left_float_width(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace,
			     ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace)
            + right_float_width(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace,
				((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace) >= ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth)
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace;
        break;
    case FtRIGHTFLOAT:
	set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace);
        if (p->u.parshape.mode & FtCLEARLEFT)
            set_max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace);
        if (p->u.parshape.width >= 0)
            ;
        else if ((p->u.parshape.mode & FtKEEPWIDTH)
            && (width = find_width_before(self, p)) >= 0)
            p->u.parshape.width = width;
#if 0
        else /* if (p->u.parshape.width < 0) */
            p->u.parshape.width = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth/3
                - p->u.parshape.left - p->u.parshape.right;
#endif
        /* check if there is no collision of floats */
	if (left_float_width(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace,
			     ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace)
            + right_float_width(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace,
				((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace) >= ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth)
            ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace;
        break;
    default:
        assert(! "Cannot happen");
    }
}
#line 1883 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1883 "FText.w"
static void format_hrule(Widget self,FtChunk  h)
#else
#line 1883 "FText.w"
static void format_hrule(self,h)Widget self;FtChunk  h;
#endif
#line 1884 "FText.w"
{
    FtChunk p;
    int mode, left, right;

    assert(h->d >= 0);
    p = render_paragraphs(self, h);
    /* p = find_parshape_before(h); */
    mode = p ? p->u.parshape.mode : FtNORMALPARA;
    left = p ? p->u.parshape.left : 0;
    right = p ? p->u.parshape.right : 0;
    switch (mode & FtPOSITIONMASK) {
    case FtNORMALPARA:
        h->y = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace;
        h->x = left_float_width(self, h->y, h->y + h->d) + left;
        h->w = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth - h->x - right
            - right_float_width(self, h->y, h->y + h->d);
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vspace = 0;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos = h->y + h->d;
        break;
    case FtLEFTFLOAT:
        h->y = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace;
        h->x = left;
        assert(p && p->u.parshape.width >= 0);
        h->w = p->u.parshape.width;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftvspace = 0;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos = h->y + h->d;
        break;
    case FtRIGHTFLOAT:
        h->y = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace;
        assert(p && p->u.parshape.width >= 0);
        h->w = p->u.parshape.width;
        h->x = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fullwidth - p->u.parshape.width - right;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightvspace = 0;
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos = h->y + h->d;
        break;
    default:
	assert(! "Cannot happen");
    }
    append_line(self, mode, h->x, h->y, h->w, h->d, h, h->next);
}
#line 1929 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1929 "FText.w"
static void unmap_children(Widget self)
#else
#line 1929 "FText.w"
static void unmap_children(self)Widget self;
#endif
#line 1930 "FText.w"
{
    FtChunk p;

    for (p = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.inlined_chunks; p; p = p->u.inlined.prev_inlined) {
	assert(p->tp == FtInline);
#if 0
	if (p->y + p->h - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset > 0 && p->y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset <= ((XfwfFormattedTextWidget)self)->core.height)
	    XtMoveWidget(p->u.inlined.widget, p->x + p->u.inlined.hmargin,
			 p->y - p->h + p->u.inlined.vmargin - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset);
	else if (p->u.inlined.mapped) {
	    XtUnmapWidget(p->u.inlined.widget);
	    p->u.inlined.mapped = FALSE;
	}
#else
	XtMoveWidget(p->u.inlined.widget, p->x + p->u.inlined.hmargin,
		     p->y - p->h + p->u.inlined.vmargin - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset);
#endif
    }
}
#line 1956 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1956 "FText.w"
static void scroll_cb(Widget  vscroll,XtPointer  client_data,XtPointer  call_data)
#else
#line 1956 "FText.w"
static void scroll_cb(vscroll,client_data,call_data)Widget  vscroll;XtPointer  client_data;XtPointer  call_data;
#endif
#line 1957 "FText.w"
{
    XmScrollBarCallbackStruct *info = (XmScrollBarCallbackStruct *) call_data;
    Widget self = (Widget) client_data;
    int delta;

    delta = info->value - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset = info->value;
    unmap_children(self);
#if 1
    XCopyArea(XtDisplay(self), XtWindow(self), XtWindow(self),
	      DefaultGCOfScreen(XtScreen(self)), 0, delta,
	      ((XfwfFormattedTextWidget)self)->core.width - ((XfwfFormattedTextWidget)vscroll)->core.width, ((XfwfFormattedTextWidget)self)->core.height, 0, 0);
#else
    XClearArea(XtDisplay(self), XtWindow(self), 0, 0, 0, 0, TRUE);
#endif
}
#line 1979 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1979 "FText.w"
static Boolean  do_layout(XtPointer  client_data)
#else
#line 1979 "FText.w"
static Boolean  do_layout(client_data)XtPointer  client_data;
#endif
#line 1980 "FText.w"
{
    Widget self = (Widget) client_data;
    FtChunk p;

    init_par_builder(self);
    for (p = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks; p; p = p->next) {
	switch (p->tp) {
	case FtWord: break;
	case FtHSpace: break;
	case FtInline: format_inline(self, p); break;
	case FtVSpace: format_vspace(self, p); break;
	case FtParShape: format_parshape(self, p); break;
	case FtHRule: format_hrule(self, p); break;
	default: assert(! "Cannot happen");
	}
    }
    unmap_children(self);
    if (XtIsRealized(self)) {
	XClearArea(XtDisplay(self), XtWindow(self), 0, 0, 0, 0, TRUE);
	/* $expose($, NULL, NULL); */
    }
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.reformat_scrollbar(self);
        ((XfwfFormattedTextWidget)self)->xfwfFormattedText.workid = 0;
    return TRUE;				/* Un-install */
}
#line 2009 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2009 "FText.w"
static void install_do_layout(Widget self)
#else
#line 2009 "FText.w"
static void install_do_layout(self)Widget self;
#endif
#line 2010 "FText.w"
{
    if (! ((XfwfFormattedTextWidget)self)->xfwfFormattedText.workid)
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.workid = XtAppAddWorkProc(XtWidgetToApplicationContext(self),
				   do_layout, self);
}
#line 2029 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2029 "FText.w"
static void load_font(Widget self,int  family,int  style,int  size)
#else
#line 2029 "FText.w"
static void load_font(self,family,style,size)Widget self;int  family;int  style;int  size;
#endif
#line 2030 "FText.w"
{
    unsigned long val;
    char s[256], *fam, *charset, *slant, *bold;
    XFontStruct *fs;
    int siz, hres, vres;

    assert(0 <= family && family < NR_FAMILIES);
    switch (family) {
    case 4:
	fam = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontFamily5;
	charset = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontCharset5;
	slant = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSlant5;
	bold = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontBold5;
	break;
    case 3:
	fam = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontFamily4;
	charset = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontCharset4;
	slant = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSlant4;
	bold = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontBold4;
	break;
    case 2:
	fam = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontFamily3;
	charset = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontCharset3;
	slant = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSlant3;
	bold = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontBold3;
	break;
    case 1:
	fam = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontFamily2;
	charset = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontCharset2;
	slant = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSlant2;
	bold = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontBold2;
	break;
    default:
	fam = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontFamily1;
	charset = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontCharset1;
	slant = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSlant1;
	bold = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontBold1;
	break;
    }
    assert(0 <= size && size < NR_SIZES);
    siz = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[family][size];
    hres = 25.4 * WidthOfScreen(XtScreen(self))/WidthMMOfScreen(XtScreen(self));
    vres = 25.4 * HeightOfScreen(XtScreen(self))/HeightMMOfScreen(XtScreen(self));
    if (abs(hres - 75) > abs(hres - 100)) hres = 100; else hres = 75;
    if (abs(vres - 75) > abs(vres - 100)) vres = 100; else vres = 75;

    switch (style) {
    case 0:					/* Normal style */
	sprintf(s, "-*-%s-medium-r-normal--*-%d-%d-%d-*-*-%s",
		fam, siz, hres, vres, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-medium-r-*--*-%d-*-*-*-*-%s", fam, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-*-medium-r-*--*-%d-*-*-*-*-%s", siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "fixed");
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	XtAppError(XtWidgetToApplicationContext(self), "Failed to find Xfonts");
	break;
    case 1:					/* Bold style */
	sprintf(s, "-*-%s-%s-r-normal--*-%d-%d-%d-*-*-%s",
		fam, bold, siz, hres, vres, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-%s-r-*--*-%d-*-*-*-*-%s",
		fam, bold, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-*-r-*--*-%d-*-*-*-*-%s",
		fam, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "fixed");
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	XtAppError(XtWidgetToApplicationContext(self), "Failed to find Xfonts");
	break;
    case 2:					/* Italic style */
	sprintf(s, "-*-%s-medium-%s-normal--*-%d-%d-%d-*-*-%s",
		fam, slant, siz, hres, vres, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-medium-%s-*--*-%d-*-*-*-*-%s",
		fam, slant, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-*-%s-*--*-%d-*-*-*-*-%s",
		fam, slant, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "fixed");
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	XtAppError(XtWidgetToApplicationContext(self), "Failed to find Xfonts");
	break;
    case 3:					/* Bold-italic style */
	sprintf(s, "-*-%s-%s-%s-normal--*-%d-%d-%d-*-*-%s",
		fam, bold, slant, siz, hres, vres, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-%s-%s-*--*-%d-*-*-*-*-%s",
		fam, bold, slant, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-*-%s-*--*-%d-*-*-*-*-%s",
		fam, slant, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "-*-%s-%s-*-*--*-%d-*-*-*-*-%s",
		fam, bold, siz, charset);
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	sprintf(s, "fixed");
	fs = XLoadQueryFont(XtDisplay(self), s);
	if (fs) break;
	XtAppError(XtWidgetToApplicationContext(self), "Failed to find Xfonts");
	break;
    default:
	assert(! "Cannot happen");
    }
    if (XGetFontProperty(fs, XA_SUPERSCRIPT_Y, &val))
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].sup = val;
    else
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].sup = fs->ascent/2;
    if (XGetFontProperty(fs, XA_SUBSCRIPT_Y, &val))
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].sub = val;
    else
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].sub = -fs->descent/2;
    if (XGetFontProperty(fs, XA_UNDERLINE_POSITION, &val))
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].ulpos = val;
    else
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].ulpos = 2;
    if (XGetFontProperty(fs, XA_UNDERLINE_THICKNESS, &val))
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].ulthick = val;
    else
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].ulthick = 1;
    if (XGetFontProperty(fs, XA_NORM_SPACE, &val))
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].space = val;
    else
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].space = XTextWidth(fs, " ", 1);
    if (XGetFontProperty(fs, XA_QUAD_WIDTH, &val))
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].em = val;
    else
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].em = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].space;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[family][style][size].fs = fs;
}
#line 2181 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2181 "FText.w"
static void interpret_style(Widget self,TextStyle  style,int * fam,int * sty,int * siz,int * raise)
#else
#line 2181 "FText.w"
static void interpret_style(self,style,fam,sty,siz,raise)Widget self;TextStyle  style;int * fam;int * sty;int * siz;int * raise;
#endif
#line 2182 "FText.w"
{
    int sup, sub;

    *fam = (style & FtFAMILYMASK) >> FtFAMILYSHIFT;
    *sty = (style & FtSTYLEMASK) >> FtSTYLESHIFT;
    *siz = (style & FtSIZEMASK) >> FtSIZESHIFT;
    sup = (style & FtSUPERMASK) >> FtSUPERSHIFT;
    sub = (style & FtSUBMASK) >> FtSUBSHIFT;
    if (! ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[*fam][*sty][*siz].fs) load_font(self, *fam, *sty, *siz);
    *raise = 0;
    for (; sup != 0; sup--) {
	*raise += ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[*fam][*sty][*siz].sup;
	if (*siz != 0) *siz--;
	if (! ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[*fam][*sty][*siz].fs) load_font(self, *fam, *sty, *siz);
    }
    for (; sub != 0; sub--) {
	*raise += ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[*fam][*sty][*siz].sup;
	if (*siz != 0) *siz--;
	if (! ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[*fam][*sty][*siz].fs) load_font(self, *fam, *sty, *siz);
    }
}
#line 2207 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2207 "FText.w"
static void font_extents(Widget self,TextStyle  style,const  String  word,int  len,int * h,int * d,int * w,int * raise)
#else
#line 2207 "FText.w"
static void font_extents(self,style,word,len,h,d,w,raise)Widget self;TextStyle  style;const  String  word;int  len;int * h;int * d;int * w;int * raise;
#endif
#line 2208 "FText.w"
{
    int fam, sty, siz;
    interpret_style(self, style, &fam, &sty, &siz, raise);
    *w = XTextWidth(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs, word, len);
    *h = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->ascent + *raise;
    *d = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->descent - *raise;
}
#line 2220 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2220 "FText.w"
static void font_space(Widget self,TextStyle  style,int * h,int * d,int * w,int * raise)
#else
#line 2220 "FText.w"
static void font_space(self,style,h,d,w,raise)Widget self;TextStyle  style;int * h;int * d;int * w;int * raise;
#endif
#line 2221 "FText.w"
{
    int fam, sty, siz;
    interpret_style(self, style, &fam, &sty, &siz, raise);
    *w = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].space;
    *h = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->ascent + *raise;
    *d = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->descent - *raise;
}
#line 2232 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2232 "FText.w"
static Font  font_id(Widget self,TextStyle  style)
#else
#line 2232 "FText.w"
static Font  font_id(self,style)Widget self;TextStyle  style;
#endif
#line 2233 "FText.w"
{
    int fam, sty, siz, raise;
    interpret_style(self, style, &fam, &sty, &siz, &raise);
    return ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->fid;
}
#line 2242 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2242 "FText.w"
static void dump_chunk(FtChunk  f)
#else
#line 2242 "FText.w"
static void dump_chunk(f)FtChunk  f;
#endif
#line 2243 "FText.w"
{
    switch (f->tp) {
    case FtWord:
	fprintf(stderr, "[FtWord, %d, %d, %d, %d + %d, \"%s\" [%s, %o]]\n",
		f->x, f->y, f->w, f->h, f->d,
		f->data ? f->data : "<none>",
		f->u.word.text, f->u.word.style);
	break;
    case FtHSpace:
	fprintf(stderr, "[FtHSpace, %d, %d, %d, %d + %d, \"%s\" [%d, %o]]\n",
		f->x, f->y, f->w, f->h, f->d,
		f->data ? f->data : "<none>",
		f->u.hspace.normwidth, f->u.hspace.style);
	break;
    case  FtInline:
	fprintf(stderr, "[FtInline, %d, %d, %d, %d + %d, \"%s\" [%ld, %o]]\n",
		f->x, f->y, f->w, f->h, f->d,
		f->data ? f->data : "<none>",
		f->u.inlined.widget, f->u.inlined.style);
	break;
    case FtVSpace:
	fprintf(stderr, "[FtVSpace, %d, %d, %d, %d + %d, \"%s\"]\n",
		f->x, f->y, f->w, f->h, f->d,
		f->data ? f->data : "<none>");
	break;
    case FtParShape:
	fprintf(stderr, "[FtParShape [%o, %d, %d, %d]]\n",
		f->u.parshape.mode, f->u.parshape.left,
		f->u.parshape.right, f->u.parshape.width);
	break;
    case FtHRule:
	fprintf(stderr, "[FtHRule, %d, %d, %d, %d + %d, \"%s\"]\n",
		f->x, f->y, f->w, f->h, f->d,
		f->data ? f->data : "<none>");
	break;
    default:
	fprintf(stderr, "???\n");
    }
}
#line 2283 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 2283 "FText.w"
static void dump(Widget self)
#else
#line 2283 "FText.w"
static void dump(self)Widget self;
#endif
#line 2284 "FText.w"
{
    FtChunk f;

    for (f = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks; f; f = f->next) dump_chunk(f);
}

static XtResource resources[] = {
#line 16 "FText.w"
{XtNfontFamily1,XtCFontFamily1,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontFamily1),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontFamily1),XtRImmediate,(XtPointer)"times"},
#line 17 "FText.w"
{XtNfontCharset1,XtCFontCharset1,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontCharset1),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontCharset1),XtRImmediate,(XtPointer)"iso8859-1"},
#line 18 "FText.w"
{XtNfontSlant1,XtCFontSlant1,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSlant1),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSlant1),XtRImmediate,(XtPointer)"i"},
#line 19 "FText.w"
{XtNfontBold1,XtCFontBold1,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontBold1),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontBold1),XtRImmediate,(XtPointer)"bold"},
#line 20 "FText.w"
{XtNfontSizes1,XtCFontSizes1,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSizes1),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSizes1),XtRImmediate,(XtPointer)"72 80 100 120 140 180 240"},
#line 22 "FText.w"
{XtNfontFamily2,XtCFontFamily2,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontFamily2),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontFamily2),XtRImmediate,(XtPointer)"helvetica"},
#line 23 "FText.w"
{XtNfontCharset2,XtCFontCharset2,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontCharset2),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontCharset2),XtRImmediate,(XtPointer)"iso8859-1"},
#line 24 "FText.w"
{XtNfontSlant2,XtCFontSlant2,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSlant2),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSlant2),XtRImmediate,(XtPointer)"o"},
#line 25 "FText.w"
{XtNfontBold2,XtCFontBold2,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontBold2),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontBold2),XtRImmediate,(XtPointer)"bold"},
#line 26 "FText.w"
{XtNfontSizes2,XtCFontSizes2,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSizes2),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSizes2),XtRImmediate,(XtPointer)"72 80 100 120 140 180 240"},
#line 28 "FText.w"
{XtNfontFamily3,XtCFontFamily3,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontFamily3),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontFamily3),XtRImmediate,(XtPointer)"courier"},
#line 29 "FText.w"
{XtNfontCharset3,XtCFontCharset3,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontCharset3),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontCharset3),XtRImmediate,(XtPointer)"iso8859-1"},
#line 30 "FText.w"
{XtNfontSlant3,XtCFontSlant3,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSlant3),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSlant3),XtRImmediate,(XtPointer)"o"},
#line 31 "FText.w"
{XtNfontBold3,XtCFontBold3,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontBold3),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontBold3),XtRImmediate,(XtPointer)"bold"},
#line 32 "FText.w"
{XtNfontSizes3,XtCFontSizes3,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSizes3),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSizes3),XtRImmediate,(XtPointer)"72 80 100 120 140 180 240"},
#line 34 "FText.w"
{XtNfontFamily4,XtCFontFamily4,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontFamily4),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontFamily4),XtRImmediate,(XtPointer)"wwwicons"},
#line 35 "FText.w"
{XtNfontCharset4,XtCFontCharset4,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontCharset4),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontCharset4),XtRImmediate,(XtPointer)"*"},
#line 36 "FText.w"
{XtNfontSlant4,XtCFontSlant4,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSlant4),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSlant4),XtRImmediate,(XtPointer)"*"},
#line 37 "FText.w"
{XtNfontBold4,XtCFontBold4,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontBold4),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontBold4),XtRImmediate,(XtPointer)"*"},
#line 38 "FText.w"
{XtNfontSizes4,XtCFontSizes4,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSizes4),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSizes4),XtRImmediate,(XtPointer)"72 80 100 120 140 180 240"},
#line 40 "FText.w"
{XtNfontFamily5,XtCFontFamily5,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontFamily5),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontFamily5),XtRImmediate,(XtPointer)"symbol"},
#line 41 "FText.w"
{XtNfontCharset5,XtCFontCharset5,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontCharset5),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontCharset5),XtRImmediate,(XtPointer)"*"},
#line 42 "FText.w"
{XtNfontSlant5,XtCFontSlant5,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSlant5),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSlant5),XtRImmediate,(XtPointer)"*"},
#line 43 "FText.w"
{XtNfontBold5,XtCFontBold5,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontBold5),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontBold5),XtRImmediate,(XtPointer)"*"},
#line 44 "FText.w"
{XtNfontSizes5,XtCFontSizes5,XtRString,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.fontSizes5),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.fontSizes5),XtRImmediate,(XtPointer)"72 80 100 120 140 180 240"},
#line 54 "FText.w"
{XtNactivate,XtCActivate,XtRCallback,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.activate),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.activate),XtRImmediate,(XtPointer)NULL },
#line 62 "FText.w"
{XtNenter,XtCEnter,XtRCallback,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.enter),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.enter),XtRImmediate,(XtPointer)NULL },
#line 68 "FText.w"
{XtNleave,XtCLeave,XtRCallback,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.leave),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.leave),XtRImmediate,(XtPointer)NULL },
#line 73 "FText.w"
{XtNactiveCursor,XtCActiveCursor,XtRCursor,sizeof(((XfwfFormattedTextRec*)NULL)->xfwfFormattedText.activeCursor),XtOffsetOf(XfwfFormattedTextRec,xfwfFormattedText.activeCursor),XtRImmediate,(XtPointer)NULL },
#line 77 "FText.w"
{XtNwidth,XtCWidth,XtRDimension,sizeof(((XfwfFormattedTextRec*)NULL)->core.width),XtOffsetOf(XfwfFormattedTextRec,core.width),XtRImmediate,(XtPointer)150 },
#line 78 "FText.w"
{XtNheight,XtCHeight,XtRDimension,sizeof(((XfwfFormattedTextRec*)NULL)->core.height),XtOffsetOf(XfwfFormattedTextRec,core.height),XtRImmediate,(XtPointer)150 },
};

XfwfFormattedTextClassRec xfwfFormattedTextClassRec = {
{ /* core_class part */
/* superclass   	*/  (WidgetClass) &xmManagerClassRec,
/* class_name   	*/  "XfwfFormattedText",
/* widget_size  	*/  sizeof(XfwfFormattedTextRec),
/* class_initialize 	*/  NULL,
/* class_part_initialize*/  _resolve_inheritance,
/* class_inited 	*/  FALSE,
/* initialize   	*/  initialize,
/* initialize_hook 	*/  NULL,
/* realize      	*/  XtInheritRealize,
/* actions      	*/  actionsList,
/* num_actions  	*/  2,
/* resources    	*/  resources,
/* num_resources 	*/  31,
/* xrm_class    	*/  NULLQUARK,
/* compres_motion 	*/  FALSE ,
/* compress_exposure 	*/  XtExposeCompressMultiple |XtExposeGraphicsExposeMerged ,
/* compress_enterleave 	*/  True ,
/* visible_interest 	*/  False ,
/* destroy      	*/  destroy,
/* resize       	*/  resize,
/* expose       	*/  expose,
/* set_values   	*/  NULL,
/* set_values_hook 	*/  NULL,
/* set_values_almost 	*/  XtInheritSetValuesAlmost,
/* get_values+hook 	*/  NULL,
/* accept_focus 	*/  XtInheritAcceptFocus,
/* version      	*/  XtVersion,
/* callback_private 	*/  NULL,
/* tm_table      	*/  defaultTranslations,
/* query_geometry 	*/  query_geometry,
/* display_acceleator 	*/  XtInheritDisplayAccelerator,
/* extension    	*/  NULL 
},
{ /* composite_class part */
geometry_manager,
XtInheritChangeManaged,
XtInheritInsertChild,
XtInheritDeleteChild,
NULL
},
{ /* constraint_class part */
/* constraint_resources     */  NULL,
/* num_constraint_resources */  0,
/* constraint_size          */  sizeof(XfwfFormattedTextConstraintRec),
/* constraint_initialize    */  NULL,
/* constraint_destroy       */  NULL,
/* constraint_set_values    */  NULL,
/* constraint_extension     */  NULL 
},
{ /* XmManager class part */
#define manager_extension extension
/* translations                 */  XtInheritTranslations ,
/* syn_resources                */  NULL ,
/* num_syn_resources            */  0 ,
/* syn_constraint_resources     */  NULL ,
/* num_syn_constraint_resources */  0 ,
/* parent_process               */  XmInheritParentProcess,
/* manager_extension            */  NULL ,
},
{ /* XfwfFormattedText_class part */
add_word,
add_hspace,
add_vspace,
add_inline,
add_parshape,
add_hrule,
add_eod,
pass_click,
reformat_scrollbar,
get_em_of_textstyle,
get_space_of_textstyle,
get_lineheight_of_textstyle,
get_word_extent,
},
};
WidgetClass xfwfFormattedTextWidgetClass = (WidgetClass) &xfwfFormattedTextClassRec;
/*ARGSUSED*/
#line 1042 "FText.w"
static void activate(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    XfwfFTextCallbackStruct info;
    int x, y;
    FtChunk p;

    switch (event->type) {
    case ButtonPress: case ButtonRelease:
	x = event->xbutton.x; y = event->xbutton.y; break;
    case MotionNotify:
	x = event->xmotion.x; y = event->xmotion.y; break;
    case EnterNotify: case LeaveNotify:
	x = event->xcrossing.x; y = event->xcrossing.y; break;
    default:
	XtAppError(XtWidgetToApplicationContext(self),
		   "activate() action called with incorrect event");
    }
    y += ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
    /* fprintf(stderr, "activate at (virtual) (%d,%d)\n", x, y); */
    if ((p = find_chunk_at_xy(self, x, y))) {
	if (p->data) {
	    info.reason = XfwfActivate;
	    info.event = event;
	    info.x = x;
	    info.y = y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
	    info.data = p->data;
	    XtCallCallbackList(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.activate, &info);
	}
    }
}

/*ARGSUSED*/
#line 1079 "FText.w"
static void motion(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    XfwfFTextCallbackStruct info;
    int x, y;
    FtChunk found;

    switch (event->type) {
    case ButtonPress: case ButtonRelease:
	x = event->xbutton.x; y = event->xbutton.y; break;
    case MotionNotify:
	x = event->xmotion.x; y = event->xmotion.y; break;
    case EnterNotify: case LeaveNotify:
	x = event->xcrossing.x; y = event->xcrossing.y; break;
    default:
	XtAppError(XtWidgetToApplicationContext(self),
		   "motion() action called with incorrect event");
    }
    y += ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
    found = find_chunk_at_xy(self, x, y);
    if (found != ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last_motion_chunk) {
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.last_motion_chunk != NULL && ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last_motion_chunk->data != NULL) {
	    info.reason = XfwfLeave;
	    info.event = event;
	    info.x = x;
	    info.y = y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
	    info.data = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last_motion_chunk->data;
	    XtCallCallbackList(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leave, &info);
	}
	if (found != NULL && found->data != NULL) {
	    XDefineCursor(XtDisplay(self), XtWindow(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.activeCursor);
	    info.reason = XfwfEnter;
	    info.event = event;
	    info.x = x;
	    info.y = y - ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
	    info.data = found->data;
	    XtCallCallbackList(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.enter, &info);
	} else {
	    XDefineCursor(XtDisplay(self), XtWindow(self), None);
	}
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.last_motion_chunk = found;
    }
}

static void _resolve_inheritance(class)
WidgetClass class;
{
  XfwfFormattedTextWidgetClass c = (XfwfFormattedTextWidgetClass) class;
  XfwfFormattedTextWidgetClass super;
  static CompositeClassExtensionRec extension_rec = {
    NULL, NULLQUARK, XtCompositeExtensionVersion,
    sizeof(CompositeClassExtensionRec), True};
  CompositeClassExtensionRec *ext;
  ext = (XtPointer)XtMalloc(sizeof(*ext));
  *ext = extension_rec;
  ext->next_extension = c->composite_class.extension;
  c->composite_class.extension = ext;
  if (class == xfwfFormattedTextWidgetClass) return;
  super = (XfwfFormattedTextWidgetClass)class->core_class.superclass;
  if (c->xfwfFormattedText_class.add_word == XtInherit_add_word)
    c->xfwfFormattedText_class.add_word = super->xfwfFormattedText_class.add_word;
  if (c->xfwfFormattedText_class.add_hspace == XtInherit_add_hspace)
    c->xfwfFormattedText_class.add_hspace = super->xfwfFormattedText_class.add_hspace;
  if (c->xfwfFormattedText_class.add_vspace == XtInherit_add_vspace)
    c->xfwfFormattedText_class.add_vspace = super->xfwfFormattedText_class.add_vspace;
  if (c->xfwfFormattedText_class.add_inline == XtInherit_add_inline)
    c->xfwfFormattedText_class.add_inline = super->xfwfFormattedText_class.add_inline;
  if (c->xfwfFormattedText_class.add_parshape == XtInherit_add_parshape)
    c->xfwfFormattedText_class.add_parshape = super->xfwfFormattedText_class.add_parshape;
  if (c->xfwfFormattedText_class.add_hrule == XtInherit_add_hrule)
    c->xfwfFormattedText_class.add_hrule = super->xfwfFormattedText_class.add_hrule;
  if (c->xfwfFormattedText_class.add_eod == XtInherit_add_eod)
    c->xfwfFormattedText_class.add_eod = super->xfwfFormattedText_class.add_eod;
  if (c->xfwfFormattedText_class.pass_click == XtInherit_pass_click)
    c->xfwfFormattedText_class.pass_click = super->xfwfFormattedText_class.pass_click;
  if (c->xfwfFormattedText_class.reformat_scrollbar == XtInherit_reformat_scrollbar)
    c->xfwfFormattedText_class.reformat_scrollbar = super->xfwfFormattedText_class.reformat_scrollbar;
  if (c->xfwfFormattedText_class.get_em_of_textstyle == XtInherit_get_em_of_textstyle)
    c->xfwfFormattedText_class.get_em_of_textstyle = super->xfwfFormattedText_class.get_em_of_textstyle;
  if (c->xfwfFormattedText_class.get_space_of_textstyle == XtInherit_get_space_of_textstyle)
    c->xfwfFormattedText_class.get_space_of_textstyle = super->xfwfFormattedText_class.get_space_of_textstyle;
  if (c->xfwfFormattedText_class.get_lineheight_of_textstyle == XtInherit_get_lineheight_of_textstyle)
    c->xfwfFormattedText_class.get_lineheight_of_textstyle = super->xfwfFormattedText_class.get_lineheight_of_textstyle;
  if (c->xfwfFormattedText_class.get_word_extent == XtInherit_get_word_extent)
    c->xfwfFormattedText_class.get_word_extent = super->xfwfFormattedText_class.get_word_extent;
}
#line 481 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 481 "FText.w"
static void initialize(Widget  request,Widget self,ArgList  args,Cardinal * num_args)
#else
#line 481 "FText.w"
static void initialize(request,self,args,num_args)Widget  request;Widget self;ArgList  args;Cardinal * num_args;
#endif
#line 482 "FText.w"
{
    int i, j, k, n;
    XtGCMask mask, dynmask, dontcaremask;
    XGCValues values;
    Widget vscroll;

    vscroll = XtVaCreateManagedWidget
	("VertScrollBar", xmScrollBarWidgetClass, self,
	 XmNpageIncrement, max(10, ((XfwfFormattedTextWidget)self)->core.height - 10),
	 XmNheight, ((XfwfFormattedTextWidget)self)->core.height,
	 NULL);
    XtMoveWidget(vscroll, ((XfwfFormattedTextWidget)self)->core.width - ((XfwfFormattedTextWidget)vscroll)->core.width, 0);
    XtAddCallback(vscroll, XmNvalueChangedCallback, scroll_cb, self);
    XtAddCallback(vscroll, XmNdragCallback, scroll_cb, self);
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vscrollbar = vscroll;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset = 0;

    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last_motion_chunk = NULL;

    mask = 0;
    dynmask = GCForeground | GCBackground | GCFont | GCLineWidth | GCClipMask;
    dontcaremask = GCJoinStyle | GCFillRule | GCTile
	| GCTileStipXOrigin | GCTileStipYOrigin | GCDashOffset | GCDashList
	| GCStipple | GCGraphicsExposures | GCArcMode;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc = XtAllocateGC(self, ((XfwfFormattedTextWidget)self)->core.depth, mask, &values, dynmask, dontcaremask);

    mask = 0;
    dynmask = GCForeground | GCClipMask;
    dontcaremask = GCBackground | GCFont
	| GCJoinStyle | GCFillRule | GCTile | GCTileStipXOrigin
	| GCTileStipYOrigin | GCDashOffset | GCDashList | GCLineWidth
	| GCGraphicsExposures | GCArcMode | GCLineStyle | GCCapStyle
	| GCStipple;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc = XtAllocateGC(self, ((XfwfFormattedTextWidget)self)->core.depth, mask, &values, dynmask, dontcaremask);

    values.stipple = XCreateBitmapFromData
	(XtDisplay(self), RootWindowOfScreen(XtScreen(self)), line3d_bits,
	 line3d_width, line3d_height);
    values.fill_style = FillOpaqueStippled;
    values.foreground = ((XfwfFormattedTextWidget)self)->xmManager.bottom_shadow_color;
    values.background = ((XfwfFormattedTextWidget)self)->xmManager.top_shadow_color;
    mask = GCFillStyle | GCStipple | GCFillStyle | GCForeground | GCBackground;
    dynmask = GCTileStipXOrigin | GCTileStipYOrigin | GCClipMask;
    dontcaremask = GCLineStyle | GCCapStyle | GCJoinStyle | GCFillRule
	| GCTile | GCDashOffset | GCDashList | GCFont | GCLineWidth
	| GCArcMode | GCGraphicsExposures;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc = XtAllocateGC(self, ((XfwfFormattedTextWidget)self)->core.depth, mask, &values, dynmask, dontcaremask); 


    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.last = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks = NULL;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.inlined_chunks = NULL;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines = NULL; ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines_alloc = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines = NULL; ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines_alloc = 0;
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines = NULL; ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines_alloc = 0;
    for (i = 0; i < NR_FAMILIES; i++)
	for (j = 0; j < NR_STYLES; j++)
	    for (k = 0; k < NR_SIZES; k++)
		((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[i][j][k].fs = NULL;

    if ((n = sscanf(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSizes1, "%d%d%d%d%d%d%d", &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][0],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][1], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][2], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][3],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][4], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][5], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][6])) == 0)
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][n++] = 120;		/* Default */
    for (; n < NR_SIZES; n++) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][n] = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[0][n-1];

    if ((n = sscanf(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSizes2, "%d%d%d%d%d%d%d", &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][0],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][1], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][2], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][3],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][4], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][5], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][6])) == 0)
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][n++] = 120;		/* Default */
    for (; n < NR_SIZES; n++) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][n] = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[1][n-1];

    if ((n = sscanf(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSizes3, "%d%d%d%d%d%d%d", &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][0],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][1], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][2], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][3],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][4], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][5], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][6])) == 0)
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][n++] = 120;		/* Default */
    for (; n < NR_SIZES; n++) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][n] = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[2][n-1];

    if ((n = sscanf(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSizes4, "%d%d%d%d%d%d%d", &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][0],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][1], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][2], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][3],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][4], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][5], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][6])) == 0)
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][n++] = 120;		/* Default */
    for (; n < NR_SIZES; n++) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][n] = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[3][n-1];

    if ((n = sscanf(((XfwfFormattedTextWidget)self)->xfwfFormattedText.fontSizes5, "%d%d%d%d%d%d%d", &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][0],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][1], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][2], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][3],
		    &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][4], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][5], &((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][6])) == 0)
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][n++] = 120;		/* Default */
    for (; n < NR_SIZES; n++) ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][n] = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fsizes[4][n-1];

    init_par_builder(self);

    /* $need_reformat = DONT_NEED_REFORMAT; */
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.workid = 0;
}
#line 577 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 577 "FText.w"
static void destroy(Widget self)
#else
#line 577 "FText.w"
static void destroy(self)Widget self;
#endif
#line 578 "FText.w"
{
    FtChunk h;
    int i, j, k;

    if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.workid) XtRemoveWorkProc(((XfwfFormattedTextWidget)self)->xfwfFormattedText.workid);
    while (((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks) {
	h = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks;
	((XfwfFormattedTextWidget)self)->xfwfFormattedText.chunks = h->next;
	if (h->tp == FtWord) XtFree(h->u.word.text);
	XtFree((String)h);
    }
    for (i = 0; i < NR_FAMILIES; i++)
	for (j = 0; j < NR_STYLES; j++)
	    for (k = 0; k < NR_SIZES; k++)
		if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[i][j][k].fs)
		    XFreeFont(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[i][j][k].fs);
    XtFree((String)((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines);
    XtFree((String)((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines);
    XtFree((String)((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines);
}
#line 604 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 604 "FText.w"
static void resize(Widget self)
#else
#line 604 "FText.w"
static void resize(self)Widget self;
#endif
#line 605 "FText.w"
{
    Widget vscroll = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.vscrollbar;

    XtConfigureWidget(vscroll, ((XfwfFormattedTextWidget)self)->core.width - ((XfwfFormattedTextWidget)vscroll)->core.width, 0,
		      ((XfwfFormattedTextWidget)vscroll)->core.width, ((XfwfFormattedTextWidget)self)->core.height, ((XfwfFormattedTextWidget)vscroll)->core.border_width);
    if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines || ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines || ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines) {
	/* $need_reformat = NEED_REFORMAT_AND_REDRAW; */
	install_do_layout(self);
    } else
	init_par_builder(self);
}
#line 626 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 626 "FText.w"
static void expose(Widget self,XEvent * event,Region  region)
#else
#line 626 "FText.w"
static void expose(self,event,region)Widget self;XEvent * event;Region  region;
#endif
#line 627 "FText.w"
{
    int x, y, w, h, i;

    if (! XtIsRealized(self)) return;

    if (region) {
	XSetRegion(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc, region);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc != ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc) XSetRegion(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc, region);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc != ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc) XSetRegion(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc, region);
    } else {
	XSetClipMask(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc, None);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc != ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc) XSetClipMask(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.linegc, None);
	if (((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc != ((XfwfFormattedTextWidget)self)->xfwfFormattedText.gc) XSetClipMask(XtDisplay(self), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.spacegc, None);
    }
    x = event ? event->xexpose.x : 0;
    y = (event ? event->xexpose.y : 0) + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset;
    w = event ? event->xexpose.width : ((XfwfFormattedTextWidget)self)->core.width;
    h = event ? event->xexpose.height : ((XfwfFormattedTextWidget)self)->core.height;

    /* fprintf(stderr, "expose FText (%d,%d,%d,%d)\n", x, y, w, h); */

    i = find_line_below_y(((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrlines, y + h) - 1;
    while (i >= 0 && ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[i].y + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[i].h > y) {
	draw_chunks(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[i].start, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.lines[i].stop);
	i--;
    }
    i = find_line_below_y(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrleftlines, y + h) - 1;
    while (i >= 0 && ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].y + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].h > y) {
	draw_chunks(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].start, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftlines[i].stop);
	i--;
    }
    i = find_line_below_y(((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.nrrightlines, y + h) - 1;
    while (i >= 0 && ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].y + ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].h > y) {
	draw_chunks(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].start, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightlines[i].stop);
	i--;
    }
}
#line 674 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 167 "FText.w"
static XtGeometryResult  geometry_manager(Widget  child,XtWidgetGeometry * request,XtWidgetGeometry * reply)
#else
#line 167 "FText.w"
static XtGeometryResult  geometry_manager(child,request,reply)Widget  child;XtWidgetGeometry * request;XtWidgetGeometry * reply;
#endif
{ Widget self = XtParent(child); {
    /* Widget $ = XtParent(child); */
    FtChunk p;
    int newwd, newht;

    /* Find the chunk that contains the widget */
    for (p = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.inlined_chunks; p && p->u.inlined.widget != child;
	p = p->u.inlined.prev_inlined)
	assert(p->tp == FtInline);

    if (! p) return XtGeometryYes;		/* Not a chunk */

    if ((request->request_mode & CWWidth)
	&& (p->u.inlined.style & FtALIGNFIXEDWIDTH) == 0) {
	newwd = request->width;			/* Allow change */
    	p->w = newwd + 2 * p->u.inlined.hmargin;
	/* if (p->y >= $voffset + $height || p->y + p->h <= $voffset)
	    $need_reformat = NEED_REFORMAT;
	else
	    $need_reformat = NEED_REFORMAT_AND_REDRAW; */
	install_do_layout(self);
    } else {
	newwd = ((XfwfFormattedTextWidget)child)->core.width;			/* Old width */
    }
    if ((request->request_mode & CWHeight)
	&& (p->u.inlined.style & FtALIGNFIXEDHEIGHT) == 0) {
	newht = request->height;		/* Allow change */
	p->h = newht - p->d + 2 * p->u.inlined.vmargin;
	/* if (p->y >= $voffset + $height || p->y + p->h <= $voffset)
	    $need_reformat = NEED_REFORMAT;
	else
	    $need_reformat = NEED_REFORMAT_AND_REDRAW; */
	install_do_layout(self);
    } else {
	newht = ((XfwfFormattedTextWidget)child)->core.height;			/* Old heigth */
    }
    XtResizeWidget(child, newwd, newht, ((XfwfFormattedTextWidget)child)->core.border_width);
    format_inline(self, p);
    return XtGeometryDone;
}
}
#line 719 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 719 "FText.w"
static XtGeometryResult  query_geometry(Widget self,XtWidgetGeometry * request,XtWidgetGeometry * reply)
#else
#line 719 "FText.w"
static XtGeometryResult  query_geometry(self,request,reply)Widget self;XtWidgetGeometry * request;XtWidgetGeometry * reply;
#endif
#line 720 "FText.w"
{
    reply->request_mode = CWWidth | CWHeight;
    reply->width = PREF_WD;
    reply->height = PREF_HT;
    if ((request->request_mode & CWWidth) && request->width > PREF_WD)
	reply->width = request->width;
    if ((request->request_mode & CWHeight) && request->height > PREF_HT)
	reply->height = request->height;
    /* fprintf(stderr, "%s: query_geometry %dx%d -> %dx%d\n",
	    XtName($), request->width, request->height,
	    reply->width, reply->height); */
    if (reply->width == ((XfwfFormattedTextWidget)self)->core.width && reply->height == ((XfwfFormattedTextWidget)self)->core.height)
	return XtGeometryNo;
    if ((request->request_mode & (CWWidth|CWHeight)) != (CWWidth|CWHeight))
	return XtGeometryAlmost;
    if (request->width != reply->width || request->height != reply->height)
	return XtGeometryAlmost;
    return XtGeometryYes;
}
#line 754 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 754 "FText.w"
static void add_word(Widget self,const  String  word,Cardinal  len,Pixel  fg,Pixel  bg,TextStyle  style,XtPointer  data)
#else
#line 754 "FText.w"
static void add_word(self,word,len,fg,bg,style,data)Widget self;const  String  word;Cardinal  len;Pixel  fg;Pixel  bg;TextStyle  style;XtPointer  data;
#endif
#line 755 "FText.w"
{
    FtChunk p;
    new(p);
    p->tp = FtWord;
#ifndef NDEBUG
    p->x = -9999;
    p->y = -9999;
#endif
    p->u.word.text = strndup(word, len);
    p->u.word.len = len;
    p->u.word.style = style;
    p->u.word.fg = fg;
    p->u.word.bg = bg;
    p->data = data;
    font_extents(self, style, word, len, &p->h, &p->d, &p->w, &p->raise);
    if (style & FtHIDEWIDTH) p->w = 0;
    p->u.word.fid = font_id(self, style);
    append(self, p);
}
#line 780 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 780 "FText.w"
static void add_hspace(Widget self,int  spacefactor,Bool  stretchable,Bool  breakable,Pixel  fg,Pixel  bg,TextStyle  style,XtPointer  data)
#else
#line 780 "FText.w"
static void add_hspace(self,spacefactor,stretchable,breakable,fg,bg,style,data)Widget self;int  spacefactor;Bool  stretchable;Bool  breakable;Pixel  fg;Pixel  bg;TextStyle  style;XtPointer  data;
#endif
#line 781 "FText.w"
{
    FtChunk p;
    new(p);
    p->tp = FtHSpace;
#ifndef NDEBUG
    p->x = -9999;
    p->y = -9999;
    p->w = -9999;				/* Set by render_one_line */
#endif
    font_space(self, style, &p->h, &p->d, &p->u.hspace.normwidth, &p->raise);
    p->u.hspace.normwidth = round(p->u.hspace.normwidth * spacefactor/1000);
    p->u.hspace.stretchable = stretchable && (spacefactor > 0);
    p->u.hspace.breakable = breakable && (spacefactor > 0);
    if (! p->u.hspace.stretchable) p->w = p->u.hspace.normwidth;
    p->u.hspace.fg = fg;
    p->u.hspace.bg = bg;
    p->u.hspace.style = style;
    p->data = data;
    append(self, p);
}
#line 806 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 806 "FText.w"
static void add_vspace(Widget self,int  pixels)
#else
#line 806 "FText.w"
static void add_vspace(self,pixels)Widget self;int  pixels;
#endif
#line 807 "FText.w"
{
    FtChunk p;
    new(p);
    p->tp = FtVSpace;
#ifndef NDEBUG
    p->x = -9999;
    p->y = -9999;
    p->w = -9999;
    p->d = -9999;
    p->raise = -9999;
    p->data = NULL;
#endif
    p->h = pixels;
    append(self, p);
    format_vspace(self, p);
}
#line 834 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 834 "FText.w"
static void add_inline(Widget self,Widget  w,TextStyle  style,int  wd,int  ht,int  dp,int  hmargin,int  vmargin,XtPointer  data)
#else
#line 834 "FText.w"
static void add_inline(self,w,style,wd,ht,dp,hmargin,vmargin,data)Widget self;Widget  w;TextStyle  style;int  wd;int  ht;int  dp;int  hmargin;int  vmargin;XtPointer  data;
#endif
#line 835 "FText.w"
{
    FtChunk p;
    int dum1, dum2, dum3;

    new(p);
    p->tp = FtInline;
#ifndef NDEBUG
    p->x = -9999;
    p->y = -9999;
    p->raise = -9999;				/* Set by format_inline */
#endif
    p->w = wd + 2 * hmargin;
    p->h = ht - dp + vmargin;
    p->d = dp + vmargin;
    p->u.inlined.hmargin = hmargin;
    p->u.inlined.vmargin = vmargin;
    p->u.inlined.widget = w;
    p->u.inlined.mapped = FALSE;
    if (XtIsRealized(w)) {
	XtUnmapWidget(w);			/* Mapped by draw_inline() */
	XLowerWindow(XtDisplay(self), XtWindow(w));
    }
    p->u.inlined.style = style;
    p->u.inlined.prev_inlined = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.inlined_chunks;	/* List of inlines */
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.inlined_chunks = p;
    p->data = data;
    if ((style & (FtALIGNFIXEDWIDTH|FtALIGNFIXEDHEIGHT))) {
	if ((style & FtALIGNFIXEDWIDTH) == 0) wd = ((XfwfFormattedTextWidget)w)->core.width;
	if ((style & FtALIGNFIXEDHEIGHT) == 0) ht = ((XfwfFormattedTextWidget)w)->core.height;
	XtResizeWidget(w, wd, ht, ((XfwfFormattedTextWidget)w)->core.border_width);
    }
    if (style & FtHIDEWIDTH) p->w = 0;
    if (data && ((XfwfFormattedTextWidget)self)->xfwfFormattedText.activeCursor && XtIsRealized(w)) {
	XDefineCursor(XtDisplay(w), XtWindow(w), ((XfwfFormattedTextWidget)self)->xfwfFormattedText.activeCursor);
	/* XtAugmentTranslations(w, enterleavetrans); */
    }
    append(self, p);
    format_inline(self, p);
}
#line 884 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 884 "FText.w"
static void add_parshape(Widget self,int  left,int  right,int  width,int  mode,double  leading)
#else
#line 884 "FText.w"
static void add_parshape(self,left,right,width,mode,leading)Widget self;int  left;int  right;int  width;int  mode;double  leading;
#endif
#line 885 "FText.w"
{
    FtChunk p;
    new(p);
    p->tp = FtParShape;
#ifndef NDEBUG
    p->x = -9999;
    p->y = -9999;
    p->w = -9999;
    p->h = -9999;
    p->d = -9999;
    p->raise = -9999;
    p->data = NULL;
#endif
    p->u.parshape.width = width;
    p->u.parshape.left = left;
    p->u.parshape.right = right;
    p->u.parshape.mode = mode;
    p->u.parshape.leading = leading;
    append(self, p);
    format_parshape(self, p);
}
#line 911 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 911 "FText.w"
static void add_hrule(Widget self)
#else
#line 911 "FText.w"
static void add_hrule(self)Widget self;
#endif
#line 912 "FText.w"
{
    FtChunk p;
    new(p);
    p->tp = FtHRule;
#ifndef NDEBUG
    p->x = -9999;
    p->y = -9999;
    p->w = -9999;
    p->raise = -9999;
    p->h = -9999;
    p->data = NULL;
#endif
    p->d = line3d_height;			/* Height of bitmap */
    append(self, p);
    format_hrule(self, p);
}
#line 933 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 933 "FText.w"
static void add_eod(Widget self)
#else
#line 933 "FText.w"
static void add_eod(self)Widget self;
#endif
#line 934 "FText.w"
{
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_vspace(self, 0);
    /* dump($); */
}
#line 944 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 944 "FText.w"
static void pass_click(Widget self,Widget  child,int  x,int  y)
#else
#line 944 "FText.w"
static void pass_click(self,child,x,y)Widget self;Widget  child;int  x;int  y;
#endif
#line 945 "FText.w"
{
    XfwfFTextCallbackStruct info;
    FtChunk p;

    for (p = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.inlined_chunks; p; p = p->u.inlined.prev_inlined)
	if (p->u.inlined.widget == child) {
	    if (p->data) {
		info.reason = XfwfActivate;
		info.event = NULL;
		info.x = x;
		info.y = y;
		info.data = p->data;
		XtCallCallbackList(self, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.activate, &info);
	    }
	    break;
	}
}
#line 966 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 966 "FText.w"
static void reformat_scrollbar(Widget self)
#else
#line 966 "FText.w"
static void reformat_scrollbar(self)Widget self;
#endif
#line 967 "FText.w"
{
    int value, slider, maximum, pageinc;

    XtVaGetValues(((XfwfFormattedTextWidget)self)->xfwfFormattedText.vscrollbar, XmNvalue, &value, NULL);
    maximum = max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.ypos, max(((XfwfFormattedTextWidget)self)->xfwfFormattedText.leftypos, ((XfwfFormattedTextWidget)self)->xfwfFormattedText.rightypos));
    set_max(maximum, 1);
    slider = min(((XfwfFormattedTextWidget)self)->core.height, maximum);
    set_min(value, maximum - slider);
    ((XfwfFormattedTextWidget)self)->xfwfFormattedText.voffset = value;
    pageinc = max(1, ((XfwfFormattedTextWidget)self)->core.height - 10);
    XtVaSetValues(((XfwfFormattedTextWidget)self)->xfwfFormattedText.vscrollbar, XmNmaximum, maximum, XmNsliderSize, slider,
		  XmNvalue, value, XmNincrement, 10,
		  XmNpageIncrement, pageinc, NULL);
}
#line 985 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 985 "FText.w"
static int  get_em_of_textstyle(Widget self,TextStyle  style)
#else
#line 985 "FText.w"
static int  get_em_of_textstyle(self,style)Widget self;TextStyle  style;
#endif
#line 986 "FText.w"
{
    int fam, sty, siz, raise;
    interpret_style(self, style, &fam, &sty, &siz, &raise);
    return ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].em;
}
#line 995 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 995 "FText.w"
static int  get_space_of_textstyle(Widget self,TextStyle  style)
#else
#line 995 "FText.w"
static int  get_space_of_textstyle(self,style)Widget self;TextStyle  style;
#endif
#line 996 "FText.w"
{
    int fam, sty, siz, raise;
    interpret_style(self, style, &fam, &sty, &siz, &raise);
    return ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].space;
}
#line 1006 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1006 "FText.w"
static void get_lineheight_of_textstyle(Widget self,TextStyle  style,int * h,int * d)
#else
#line 1006 "FText.w"
static void get_lineheight_of_textstyle(self,style,h,d)Widget self;TextStyle  style;int * h;int * d;
#endif
#line 1007 "FText.w"
{
    int fam, sty, siz, raise;
    interpret_style(self, style, &fam, &sty, &siz, &raise);
    *h = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->ascent;
    *d = ((XfwfFormattedTextWidget)self)->xfwfFormattedText.fonts[fam][sty][siz].fs->descent;
}
#line 1020 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 1020 "FText.w"
static void get_word_extent(Widget self,const  String  word,Cardinal  len,TextStyle  textstyle,int * h,int * d,int * w,int * raise)
#else
#line 1020 "FText.w"
static void get_word_extent(self,word,len,textstyle,h,d,w,raise)Widget self;const  String  word;Cardinal  len;TextStyle  textstyle;int * h;int * d;int * w;int * raise;
#endif
#line 1021 "FText.w"
{
    font_extents(self, textstyle, word, len, h, d, w, raise);
}
#line 93 "FText.w"
#line 94 "FText.w"
#line 95 "FText.w"
#line 97 "FText.w"
#line 119 "FText.w"
#line 121 "FText.w"
#line 122 "FText.w"
#line 123 "FText.w"
#line 124 "FText.w"
#line 125 "FText.w"
#line 126 "FText.w"
#line 127 "FText.w"
#line 128 "FText.w"
#line 129 "FText.w"
#line 131 "FText.w"
#line 132 "FText.w"
#line 133 "FText.w"
#line 134 "FText.w"
#line 135 "FText.w"
#line 136 "FText.w"
#line 137 "FText.w"
#line 139 "FText.w"
#line 140 "FText.w"
#line 142 "FText.w"
#line 143 "FText.w"
#line 145 "FText.w"
#line 146 "FText.w"
#line 147 "FText.w"
#line 148 "FText.w"
#line 150 "FText.w"
#line 151 "FText.w"
#line 152 "FText.w"
#line 153 "FText.w"
#line 157 "FText.w"
#line 158 "FText.w"
#line 159 "FText.w"
#line 160 "FText.w"
#line 161 "FText.w"
#line 162 "FText.w"
#line 163 "FText.w"
#line 164 "FText.w"
#line 169 "FText.w"
#line 170 "FText.w"
#line 171 "FText.w"
#line 172 "FText.w"
#line 173 "FText.w"
#line 174 "FText.w"
#line 176 "FText.w"
#line 177 "FText.w"
#line 178 "FText.w"
#line 179 "FText.w"
#line 180 "FText.w"
#line 182 "FText.w"
#line 183 "FText.w"
#line 184 "FText.w"
#line 186 "FText.w"
#line 192 "FText.w"
#line 220 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 220 "FText.w"
void XfwfAddWord(Widget self,const  String  word,Cardinal  len,Pixel  fg,Pixel  bg,TextStyle  style,XtPointer  data)
#else
#line 220 "FText.w"
void XfwfAddWord(self,word,len,fg,bg,style,data)Widget self;const  String  word;Cardinal  len;Pixel  fg;Pixel  bg;TextStyle  style;XtPointer  data;
#endif
#line 221 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_word(self, word, len, fg, bg, style, data);
}
#line 239 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 239 "FText.w"
void XfwfAddHSpace(Widget self,int  spacefactor,Bool  stretchable,Bool  breakable,Pixel  fg,Pixel  bg,TextStyle  style,XtPointer  data)
#else
#line 239 "FText.w"
void XfwfAddHSpace(self,spacefactor,stretchable,breakable,fg,bg,style,data)Widget self;int  spacefactor;Bool  stretchable;Bool  breakable;Pixel  fg;Pixel  bg;TextStyle  style;XtPointer  data;
#endif
#line 240 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_hspace(self, spacefactor, stretchable, breakable, fg, bg, style, data);
}
#line 251 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 251 "FText.w"
void XfwfAddVSpace(Widget self,int  pixels)
#else
#line 251 "FText.w"
void XfwfAddVSpace(self,pixels)Widget self;int  pixels;
#endif
#line 252 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_vspace(self, pixels);
}
#line 276 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 276 "FText.w"
void XfwfAddInline(Widget self,Widget  w,TextStyle  style,int  wd,int  ht,int  dp,int  hmargin,int  vmargin,XtPointer  data)
#else
#line 276 "FText.w"
void XfwfAddInline(self,w,style,wd,ht,dp,hmargin,vmargin,data)Widget self;Widget  w;TextStyle  style;int  wd;int  ht;int  dp;int  hmargin;int  vmargin;XtPointer  data;
#endif
#line 277 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_inline(self, w, style, wd, ht, dp, hmargin, vmargin, data);
}
#line 296 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 296 "FText.w"
void XfwfAddParShape(Widget self,int  left,int  right,int  width,int  mode,double  leading)
#else
#line 296 "FText.w"
void XfwfAddParShape(self,left,right,width,mode,leading)Widget self;int  left;int  right;int  width;int  mode;double  leading;
#endif
#line 297 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_parshape(self, left, right, width, mode, leading);
}
#line 305 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 305 "FText.w"
void XfwfAddHRule(Widget self)
#else
#line 305 "FText.w"
void XfwfAddHRule(self)Widget self;
#endif
#line 306 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_hrule(self);
}
#line 316 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 316 "FText.w"
void XfwfAddEOD(Widget self)
#else
#line 316 "FText.w"
void XfwfAddEOD(self)Widget self;
#endif
#line 317 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.add_eod(self);
}
#line 329 "FText.w"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 329 "FText.w"
void XfwfPassClick(Widget self,Widget  child,int  x,int  y)
#else
#line 329 "FText.w"
void XfwfPassClick(self,child,x,y)Widget self;Widget  child;int  x;int  y;
#endif
#line 330 "FText.w"
{
    assert(XtIsSubclass(self, xfwfFormattedTextWidgetClass));
    ((XfwfFormattedTextWidgetClass)self->core.widget_class)->xfwfFormattedText_class.pass_click(self, child, x, y);
}
